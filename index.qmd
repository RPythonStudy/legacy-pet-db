---
title: PET 데이터베이스 만들기
author: BenKorea
description: "데이터베이스를 만드는 과정 기록"
date: "2025-07-23"
date-modified: last-modified
toc-depth: 4
---

```{r setup, echo=FALSE, message=FALSE}
library(here)
library(readxl)
library(dplyr)
library(data.table)

invisible(lapply(
  list.files(here::here("R"), pattern = "\\.R$", full.names = TRUE),
  source,
  encoding = "UTF-8"
))

```

```{r}
#| label: interpretation_access_raw

interpretation_access_raw <- my_read_excel_dir(directory="./data/interpretation_access/", pattern = "\\.xlsx$")
# ptid validation에 이상없어 na를 사용할 예정략
# interpretation_access_raw_invalid_ptid <- my_validate_ptid (interpretation_access_raw, "PtID")
# colSums(is.na(interpretation_access_raw))

# interpretation_access_raw %>%
#   count(ExamName, sort = TRUE)
# ExamName에서는 PET or 18F를 검색하면 됨 

pet_interpretation_access_raw <- interpretation_access_raw %>%
  filter(grepl("PET|18F", ExamName, ignore.case = TRUE))

pet_interpretation_access_raw_na_ptid <- pet_interpretation_access_raw %>%
   filter(is.na(`PtID`))

pet_interpretation_access_raw_ptid <- pet_interpretation_access_raw %>%
   filter(!is.na(`PtID`))

```

```{r}
#| label: pet_interpretation_access

preparation_access_raw <- my_read_excel_dir(directory="./data/preparation_access/", pattern = "\\.xlsx$")

pet_interpretation_access_raw_na_ptid_updated_ptid <- merge(
  pet_interpretation_access_raw_na_ptid,
  preparation_access_raw[, .(PtName, ExamDate, PtID)], 
  by = c("PtName", "ExamDate"), 
  all.x = TRUE
)

pet_interpretation_access_raw_final <- pet_interpretation_access_raw_na_ptid_updated_ptid %>%
  select(-PtID.x) %>%                 # PtID.x 컬럼 삭제
  rename(PtID = PtID.y) %>%           # PtID.y를 PtID로 이름 변경
  filter(!is.na(PtID))                # PtID가 NA인 행은 제거

pet_interpretation_access <- bind_rows(
  pet_interpretation_access_raw_ptid,
  pet_interpretation_access_raw_final
)


```

```{r}
#| label: preparation_access
#| 
preparation_access_raw_invalid_ptid <- my_validate_ptid (preparation_access_raw, "PtID")
#  colSums(is.na(preparation_access_raw))
preparation_access_na_ptid <- preparation_access_raw %>%
  filter(is.na(`PtID`))

```

```{r}
#| label: pet_pacs

pet_pacs_raw <- my_read_excel_dir(directory="./data/pt_pacs/", pattern = "\\.xlsx$")

pet_pacs_na_study_date <- pet_pacs_raw %>%
  filter(is.na(`Study Date`))

pet_pacs <- pet_pacs_raw %>%
  filter(!is.na(`Study Date`))

pet_pacs_na_Age <- pet_pacs %>%
  filter(is.na(`Age`))

pet_pacs <- pet_pacs %>%
  filter(!is.na(`Age`))

pet_pacs_invalid_ptid <- my_validate_ptid (pet_pacs, "ID")

```

-   전산자료임에도 불구하고 Study Date가 NA여서 이 데이터셋을 삭제하였고
-   Age가 NA 인 경우도 삭제를 하고 진행하였습니다. N='r nrow(pet_pacs)\`

```{r}
#| label: pet_pacs

pet_pacs[, `Req. Date` := as.Date(as.numeric(`Req. Date`), origin = "1899-12-30")]
pet_pacs[, `Study Date` := as.Date(as.numeric(`Study Date`), origin = "1899-12-30")]

pet_pacs_age_y <- pet_pacs %>%
  filter(grepl("Y", Age, ignore.case = TRUE)) 

pet_pacs[, `Age` := as.numeric(`Age`),]

pet_pacs_outsdie <- pet_pacs %>%
  filter(grepl("outside", `Req. Name`, ignore.case = TRUE)) 

```

-   여기에는 outside PET가 5419 case 포함되어 있습니다.

## PET 판독소견조회 (OCR)

```{r}
#| label: "interpretation_ocr"

interpretation_ocr <- my_read_excel_dir (directory="./data/interpretation_ocr/", pattern = "\\.xlsx$")
```

-   PACS의 PET 검사목록과는 별개로, OCR에서 PET 판독소견을 조회할 수 있으며, 이는 영상은 없지만 판독소견은 존재합니다.
-   OCR/핵의학체내/검사관리결과/판독소견조회 메뉴를 사용하면 됩니다.
-   `2000-07-04`부터 조회됩니다.
-   전산팀으로부터 받은 자료를 통합해서 interpretation_ocr이란 데이터테이블로 만들었습니다.

```{r}
#| label: "interpretation_ocr_na"

colSums(is.na(interpretation_ocr))
interpretation_ocr_na <- interpretation_ocr %>%
  filter(is.na(실시일시))

```

-   특이하게도 2009년 12월에 주로 처방한 데이터셋의 일부에서 실시일시 NA가 발견되었습니다.

```{r}
#| label: as.Date
 

interpretation_ocr <- interpretation_ocr %>%
  mutate(
    처방일자 = as.Date(처방일자),
    실시일시 = as.Date(실시일시)
  )

interpretation_ocr <- interpretation_ocr %>%
  filter(!grepl("Y", 나이, ignore.case = TRUE)) %>%
  mutate(나이 = as.numeric(나이))

interpretation_ocr_invalid_ptid <- my_validate_ptid (interpretation_ocr, "환자번호")

```

## PET 검사기록지관리 (매뉴얼)

-   OCR/핵의학체내/검사관리/검사기록지관리 메뉴
-   PET 검사기록지가 조회가 되기 시작하는 것이 대략적으로 2007-09-27 부터입니다.
-   2007-09-27 이후라고 할지라도 2009년경까지는 일부는 검사기록지가 있고 일부는 없고 일관성 없습니다.
-   전산팀으로부터 전달받은 자료를 `preparation_ocr`로 읽어 드립니다.

```{r}
#| label: "preparation_ocr"



preparation_ocr <- my_read_excel_dir("./data/preparation_ocr/", pattern = "\\.xlsx$")

colSums(is.na(preparation_ocr))

preparation_ocr_na <- preparation_ocr %>%
  filter(is.na(검사일자))

preparation_ocr_invalide_ptid <- my_validate_ptid (preparation_ocr, "환자번호")

preparation_ocr_bwt <- preparation_ocr %>%
  filter(!is.na(WEIGHT))

```

## PET 준비기록 at Access database

-   핵의학과에서는 PET 준비기록 및 판독을 Access로 관리했다가 병원전산으로 이관되었음 (정확한 기준일은 모름)
-   Access 상의 PET 준비기록은 2000-01-25부터 존재하지만 실제적인 입력은 `2000-05-02`부터 된 것으로 판단됨.
-   Access 상의 PET 준비기록은 `2009-08-07`까지 존재함

## PET 검사목록의 확보

-   2003\~2016년 PACS 상 PET 검사기록 (전산팀 유래)

## PET 준비기록 보존 전략

-   따라서 PET 준비기록도 최소한 `2003-05-12`부터 보존하는 전략이 필요

```{r}
#| label: "load-prepertation_access"
#| 
library(readxl)
preperation_raw <- read_excel("./data/access/PET_Preparation_Information_on_Access.xlsx")
preperation_access <- subset(preperation_raw, !is.na(PtID) & !is.na(ExamDate))
preperation_access_since_030512 <- preperation_access %>%
    mutate(ExamDate = as.Date(ExamDate)) %>%
  filter(ExamDate >= as.Date("2005-03-12"))
```

## PET 준비기록 on OCR

-   OCR/핵의학체내/검사관리/검사기록지관리 메뉴에서 조회를 해보면
-   PET 검사기록지가 조회가 되기 시작하는 것이 대략적으로 2007-09-27 부터임.
-   게다가 일부는 검사기록지가 있고 일부는 없음

정확한 명칭인지는 모르겠지만 검사기록지관리
